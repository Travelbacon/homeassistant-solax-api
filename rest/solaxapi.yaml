- resource: https://global.solaxcloud.com/api/v2/dataAccess/realtimeInfo/get
  method: POST	
  headers:
    Content-Type: application/json  
    tokenId: !secret SolaxTokenId
  payload: !secret SolaxWifiSnPayload
  scan_interval: 300 #Cloud updates once per 5 minutes.
  timeout: 60

  sensor:
  #Status
    - name: "Solax Cloud connection status"
      value_template: "{{ value_json['exception'] }}"    
      icon: >-
        {% if value_json['success'] == true %}mdi:cloud-check-outline
        {% else %}mdi:cloud-mdi-cancel-outline
        {% endif %}

    - name: "Solax cloud last update"
      value_template: "{{ value_json['result']['uploadTime'] }}"      
      #device_class: date
      icon: mdi:calendar-range

  #Inverter status
    - name: "Solax inverter status"
      value_template: >-
        {% set inverterStatusMap = {
          100: 'Waiting for operation',
          101: 'Self-test',
          102: 'Normal',
          103: 'Fault',
          104: 'Permanent fault',
          105: 'Firmware upgrade',
          106: 'EPS detection',
          107: 'EPS',
          108: 'Self-test',
          109: 'Sleep mode',
          110: 'Standby mode',
          111: 'Photovoltaic wake-up battery mode',
          112: 'Generator detection mode',
          113: 'Generator mode',
          114: 'Fast shutdown standby mode',
          130: 'VPP mode',
          131: 'TOU-Self use',
          132: 'TOU-Charging',
          133: 'TOU-Discharging'
        } %}
        {{ inverterStatusMap.get(value_json['result']['inverterStatus'] | int, 'Unknown status') }}
      
    - name: "Solax rated power"
      value_template: "{{ value_json['result']['ratedPower'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement  
 
  # Solar panel output to inverter (DC)
    - name: "Solax PV1 input current"
      value_template: "{{ value_json['result']['idc1'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax PV2 input current"
      value_template: "{{ value_json['result']['idc2'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax PV3 input current"
      value_template: "{{ value_json['result']['idc3'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax PV4 input current"
      value_template: "{{ value_json['result']['idc4'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
    
    - name: "Solax PV1 input voltage"
      value_template: "{{ value_json['result']['vdc1'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage 
      state_class: measurement

    - name: "Solax PV2 input voltage"
      value_template: "{{ value_json['result']['vdc2'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage 
      state_class: measurement

    - name: "Solax PV3 input voltage"
      value_template: "{{ value_json['result']['vdc3'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage 
      state_class: measurement

    - name: "Solax PV4 input voltage"
      value_template: "{{ value_json['result']['vdc4'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage 
      state_class: measurement

    - name: "Solax PV1 input power"
      value_template: "{{ value_json['result']['powerdc1'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-power

    - name: "Solax PV2 input power"
      value_template: "{{ value_json['result']['powerdc2'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-power

    - name: "Solax PV3 input power"
      value_template: "{{ value_json['result']['powerdc3'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-power

    - name: "Solax PV4 input power"
      value_template: "{{ value_json['result']['powerdc4'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-power

    # Solax doesn't supply a total of all PV arrays
    - name: "Solax PV total input power"
      value_template: "{{ value_json['result']['powerdc1'] | float(0) + value_json['result']['powerdc2'] | float(0) + value_json['result']['powerdc3'] | float(0) + value_json['result']['powerdc4'] | float(0) }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-power


  #Inverter output
    - name: "Solax inverter output power"
      value_template: "{{ value_json['result']['acpower'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-panel-large

    - name: "Solax inverter output power 1"
      value_template: "{{ value_json['result']['pac1'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-panel

    - name: "Solax inverter output power 2"
      value_template: "{{ value_json['result']['pac2'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-panel

    - name: "Solax inverter output power 3"
      value_template: "{{ value_json['result']['pac3'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:solar-panel

    - name: "Solax inverter current 1"
      value_template: "{{ value_json['result']['iac1'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax inverter current 2"
      value_template: "{{ value_json['result']['iac2'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax inverter current 3"
      value_template: "{{ value_json['result']['iac3'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax inverter voltage 1"
      value_template: "{{ value_json['result']['vac1'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax inverter voltage 2"
      value_template: "{{ value_json['result']['vac2'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax inverter voltage 3"
      value_template: "{{ value_json['result']['vac3'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax inverter frequency 1"
      value_template: "{{ value_json['result']['fac1'] | float }}"
      unit_of_measurement: "Hz"
      device_class: frequency
      state_class: measurement
 
    - name: "Solax inverter frequency 2"
      value_template: "{{ value_json['result']['fac2'] | float }}"
      unit_of_measurement: "Hz"
      device_class: frequency
      state_class: measurement
 
    - name: "Solax inverter frequency 3"
      value_template: "{{ value_json['result']['fac3'] | float }}"
      unit_of_measurement: "Hz"
      device_class: frequency
      state_class: measurement

  #Grid data 
    #current power from/to grid.
    - name: "Solax grid export power"
      value_template: "{{ value_json['result']['feedinpower'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:transmission-tower-export 

  # Consume power is not provided by Solax and calculated
    - name: "Solax consume energy"
      value_template: "{{ value_json['result']['acpower'] | float(0) - value_json['result']['feedinpower']
      unit_of_measurement: "W"
      device_class: energy
      state_class: total
      icon: mdi:home-lightning-bolt-outline

  #battery
    - name: "Solax battery status"
      value_template: >-
        {% set batStatusMap = {
          0: 'Normal',
          1: 'Fault',
          2: 'Disconnected'
        } %}
        {{ batStatusMap.get(value_json['result']['batStatus'] | int, 'Unknown status') }}
      icon: >-
        {% set batStatus = value_json['result']['batStatus'] | int %}
        {% if batStatus == 0 %}mdi:battery-check
        {% elif batStatus == 1 %}mdi:battery-alert
        {% elif batStatus == 2 %}mdi:battery-remove
        {% else %}mdi:battery-unknown
        {% endif %}

    - name: "Solax battery capacity"
      value_template: "{{ value_json['result']['soc'] | float }}"
      unit_of_measurement: "%"
      state_class: measurement
      device_class: battery

    - name: "Solax battery cycle times"
      value_template: "{{ value_json['result']['batcycle'] }}"
      state_class: measurement
      icon: mdi:battery-sync-outline

    - name: "Solax battery voltage"
      value_template: "{{ value_json['result']['batVoltage'] | float }}"
      unit_of_measurement: "V"
      state_class: measurement
      device_class: voltage

    - name: "Solax battery current"
      value_template: "{{ value_json['result']['batCurrent'] | float }}"
      unit_of_measurement: "A"
      state_class: measurement
      device_class: current

    - name: "Solax battery power"
      value_template: "{{ value_json['result']['batPower'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      icon: mdi:power-plug-battery-outline

    - name: "Solax battery output frequency"
      value_template: "{{ value_json['result']['epsfreq'] | float }}"
      unit_of_measurement: "Hz"
      device_class: frequency
      state_class: measurement

    - name: "Solax battery internal temperature"
      value_template: "{{ value_json['result']['battemper'] | float }}"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement

    - name: "Solax EPS A phase voltage"
      value_template: "{{ value_json['result']['veps1'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax EPS B phase voltage"
      value_template: "{{ value_json['result']['veps2'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax EPS C phase voltage"
      value_template: "{{ value_json['result']['veps3'] | float }}"
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement

    - name: "Solax EPS A phase current"
      value_template: "{{ value_json['result']['ieps1'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax EPS B phase current"
      value_template: "{{ value_json['result']['ieps2'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax EPS C phase current"
      value_template: "{{ value_json['result']['ieps3'] | float }}"
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement

    - name: "Solax EPS A phase active power"
      value_template: "{{ value_json['result']['peps1'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "Solax EPS B phase active power"
      value_template: "{{ value_json['result']['peps2'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "Solax EPS C phase active power"
      value_template: "{{ value_json['result']['peps3'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

  #Site statistics
    - name: "Solax yield today"
      value_template: "{{ value_json['result']['yieldtoday'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:solar-power-variant-outline

    - name: "Solax yield total"
      value_template: "{{ value_json['result']['yieldtotal'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:solar-power-variant-outline

    - name: "Solax grid import total"
      value_template: "{{ value_json['result']['consumeenergy'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:transmission-tower-import

    - name: "Solax grid export total"
      value_template: "{{ value_json['result']['feedinenergy'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:transmission-tower-export

   - name: "Solax inverter power total"
     value_template: "{{ value_json['result']['acenergyin'] }}"
     unit_of_measurement: "kWh"
     device_class: energy
     state_class: total
     icon: mdi:solar-power-power-variant-outline

   - name: "Solax PV power total"
     value_template: {{ value_json['result']['pvenergy'] }}"
     unit_of_measurement: "kWH"
     device_class: energy
     state_class: total
     icon: mdi:solar-power
  

  #Meter 2
    - name: "Solax meter 2 power"
      value_template: "{{ value_json['result']['feedinpowerM2'] | float }}"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "Solax meter 2 export to grid"
      value_template: "{{ value_json['result']['feedinenergyM2'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:transmission-tower-export

    - name: "Solax meter 2 import from grid"
      value_template: "{{ value_json['result']['consumeenergyM2'] | float }}"
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      icon: mdi:transmission-tower-import


  #other data
    - name: "Radiator temperature"
      value_template: "{{ value_json['result']['temperature'] | float }}"
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
